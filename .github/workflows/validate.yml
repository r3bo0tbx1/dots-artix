name: ğŸ” Dotfiles Validation

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]
  workflow_dispatch:

jobs:
  validate:
    name: âš™ï¸ Run All Validation Checks
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ” Run ShellCheck on all shell scripts
        uses: ludeeus/action-shellcheck@master
        with:
          severity: warning
          ignore_paths: .git .github node_modules
        continue-on-error: true

      - name: ğŸ“„ Create dependency file
        run: |
          echo "yamllint" > requirements.txt
          echo "toml" >> requirements.txt

      - name: ğŸ Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'
          cache: 'pip' 

      - name: ğŸ”§ Install validation tools
        run: pip install -r requirements.txt

      - name: ğŸ“ Validate TOML and YAML files
        run: |
          echo "ğŸ” Checking TOML syntax..."
          find . -name "*.toml" -type f | while read -r file; do
            echo "  ğŸ“„ Validating: $file"
            python3 -c "import toml; toml.load('$file')" || exit 1
          done
          echo "âœ¨ All TOML files are valid!"
          echo "ğŸ” Checking YAML syntax..."
          yamllint -d "{extends: default, rules: {line-length: disable, comments: disable}}" .github/ || true
          echo "âœ¨ YAML validation complete!"

      - name: ğŸ”’ Check for hardcoded user paths
        run: |
          echo "ğŸ” Searching for hardcoded paths in code files..."
          if grep -r "/home/[a-z_][a-z0-9_-]*/" \
            --exclude-dir=.git \
            --exclude-dir=.github \
            --exclude="*.md" \
            --exclude=".p10k.zsh" \
            --include="*.conf" \
            --include="*.toml" \
            --include="*.sh" \
            --include="*.rasi" \
            --include="layout" \
            .; then
            echo "âŒ Found hardcoded home directory paths!"
            exit 1
          else
            echo "âœ… No hardcoded user paths found!"
          fi

      - name: ğŸ” Verify script executability
        run: |
          failed=0
          if [ -d "Scripts" ]; then
            while IFS= read -r script; do
              [ -x "$script" ] || failed=1
            done < <(find Scripts -type f \( -name "*.sh" -o -name "lockscreen" \))
          fi
          if [ $failed -eq 1 ]; then exit 1; fi

      - name: ğŸ“š Check required documentation
        run: |
          if [ ! -f "README.md" ]; then exit 1; fi

      - name: ğŸ”— Check for broken internal links
        run: |
          if [ -f "README.md" ] && grep -q "install.sh" README.md; then
             [ -f "install.sh" ] || exit 1
          fi

  install-script-test:
    name: ğŸ§ª Install Script Test (Arch Linux)
    runs-on: ubuntu-latest
    container:
      image: archlinux:latest
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Arch environment
        run: |
          pacman -Syu --noconfirm
          pacman -S --noconfirm git base-devel

      - name: ğŸ§ª Dry-run install script validation
        run: |
          if [ ! -f "install.sh" ]; then exit 1; fi
          bash -n install.sh

  summary:
    name: ğŸ“Š Validation Summary
    runs-on: ubuntu-latest
    needs: [validate, install-script-test]
    if: needs.validate.result == 'success' && needs.install-script-test.result == 'success'
    steps:
      - name: ğŸ‰ Generate Dashboard
        run: |
          echo "# ğŸš€ Validation Successful" >> $GITHUB_STEP_SUMMARY
          echo "### âœ¨ Your dotfiles are clean and ready for deployment!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Component | Status | Checked By |" >> $GITHUB_STEP_SUMMARY
          echo "| :--- | :---: | :--- |" >> $GITHUB_STEP_SUMMARY
          echo "| **Script Syntax** | âœ… Pass | ShellCheck |" >> $GITHUB_STEP_SUMMARY
          echo "| **Configs** | âœ… Pass | YamlLint / TOML |" >> $GITHUB_STEP_SUMMARY
          echo "| **Security** | âœ… Pass | Path Auditor |" >> $GITHUB_STEP_SUMMARY
          echo "| **Arch Install** | âœ… Pass | Arch Container |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "> *Run ID: ${{ github.run_id }} | Commit: ${{ github.sha }}*" >> $GITHUB_STEP_SUMMARY
