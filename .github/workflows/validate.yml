name: ğŸ” Dotfiles Validation

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

jobs:
  validate:
    name: âš™ï¸ Run All Validation Checks
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ” Run ShellCheck on all shell scripts
        uses: ludeeus/action-shellcheck@master
        with:
          scandir: '.'
          severity: warning
          ignore_paths: .git .github node_modules
        continue-on-error: true

      - name: ğŸ”§ Install validation tools
        run: |
          sudo apt-get update
          sudo apt-get install -y yamllint python3-toml

      - name: ğŸ“ Validate TOML and YAML files
        run: |
          echo "ğŸ” Checking TOML syntax..."
          find . -name "*.toml" -type f | while read -r file; do
            echo "  ğŸ“„ Validating: $file"
            python3 -c "import toml; toml.load('$file')" || exit 1
          done
          echo "âœ¨ All TOML files are valid!"
          echo "ğŸ” Checking YAML syntax..."
          yamllint -d "{extends: default, rules: {line-length: disable, comments: disable}}" .github/ || true
          echo "âœ¨ YAML validation complete!"

      - name: ğŸ”’ Check for hardcoded user paths
        run: |
          echo "ğŸ” Searching for hardcoded paths in code files..."
          if grep -r "/home/[a-z_][a-z0-9_-]*/" \
            --exclude-dir=.git \
            --exclude-dir=.github \
            --exclude="*.md" \
            --exclude=".p10k.zsh" \
            --include="*.conf" \
            --include="*.toml" \
            --include="*.sh" \
            --include="*.rasi" \
            --include="layout" \
            .; then
            echo "âŒ Found hardcoded home directory paths in configuration files!"
            echo "ğŸ’¡ These should use \$HOME or ~ instead"
            exit 1
          else
            echo "âœ… No hardcoded user paths found in configuration files!"
          fi
          echo ""
          echo "ğŸ’¡ Documentation files (*.md) and auto-generated configs (.p10k.zsh) are excluded"
          echo "ğŸ‰ All path checks passed!"

      - name: ğŸ” Verify script executability
        run: |
          echo "ğŸ” Checking script permissions..."
          failed=0

          if [ -d "Scripts" ]; then
            echo "ğŸ“‚ Checking Scripts/ directory..."
            while IFS= read -r script; do
              if [ -x "$script" ]; then
                echo "  âœ… $script is executable"
              else
                echo "  âŒ $script is NOT executable!"
                failed=1
              fi
            done < <(find Scripts -type f \( -name "*.sh" -o -name "lockscreen" -o -name "flightmode" -o -name "battery-checknow" -o -name "afk*" \))
          fi

          if [ -d ".config/hypr/scripts" ]; then
            echo "ğŸ“‚ Checking .config/hypr/scripts/ directory..."
            while IFS= read -r script; do
              if [ -x "$script" ]; then
                echo "  âœ… $script is executable"
              else
                echo "  âŒ $script is NOT executable!"
                failed=1
              fi
            done < <(find .config/hypr/scripts -type f -name "*.sh")
          fi

          if [ -f "install.sh" ]; then
            chmod +x install.sh
            echo "  âœ… install.sh is executable"
          fi

          if [ $failed -eq 1 ]; then
            echo "âŒ Some scripts are not executable! Please fix permissions."
            exit 1
          fi

          echo "âœ¨ All scripts have correct permissions!"

      - name: ğŸ“š Check required documentation
        run: |
          echo "ğŸ“š Checking for required documentation files..."
          if [ -f "README.md" ]; then
            echo "  âœ… README.md exists"
            word_count=$(wc -w < "README.md")
            echo "     ğŸ“Š Word count: $word_count"
          else
            echo "  âŒ README.md is missing!"
            exit 1
          fi
          echo ""
          echo "âœ¨ All required documentation present!"

      - name: ğŸ”— Check for broken internal links
        run: |
          echo "ğŸ”— Checking for broken internal file references..."
          if [ -f "README.md" ]; then
            echo "ğŸ“„ Checking README.md..."
            if grep -q "install.sh" README.md; then
              if [ -f "install.sh" ]; then
                echo "  âœ… Referenced file exists: install.sh"
              else
                echo "  âŒ Referenced file missing: install.sh"
                exit 1
              fi
            fi
          fi
          echo "âœ¨ No broken critical links found!"

  install-script-test:
    name: ğŸ§ª Install Script Test (Arch Linux)
    runs-on: ubuntu-latest
    container:
      image: archlinux:latest
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Arch environment
        run: |
          echo "ğŸ”„ Updating system..."
          pacman -Syu --noconfirm
          pacman -S --noconfirm git base-devel

      - name: ğŸ§ª Dry-run install script validation
        run: |
          echo "ğŸ” Validating install.sh structure..."
          if [ ! -f "install.sh" ]; then
            echo "âŒ install.sh not found!"
            exit 1
          fi
          echo "ğŸ” Checking for required functions..."
          required_functions=("print_header" "print_success" "print_error" "ask_confirmation" "check_command")
          for func in "${required_functions[@]}"; do
            if grep -q "^${func}()" install.sh; then
              echo "  âœ… Function '$func' found"
            else
              echo "  âš ï¸ Function '$func' not found (might be okay)"
            fi
          done
          if grep -q "set -e" install.sh; then
            echo "  âœ… Error handling enabled (set -e)"
          else
            echo "  âš ï¸ No 'set -e' found"
          fi
          echo ""
          echo "ğŸ” Validating shell syntax..."
          bash -n install.sh
          echo "  âœ… Syntax is valid!"
          echo ""
          echo "âœ¨ Install script validation complete!"
          echo "ğŸ’¡ Note: Full execution test skipped (would modify system)"

  summary:
    name: ğŸ“Š Validation Summary
    runs-on: ubuntu-latest
    needs: [validate, install-script-test]
    if: always()
    steps:
      - name: ğŸ‰ All checks complete
        run: |
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘   âœ¨ Validation Pipeline Complete âœ¨   â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "ğŸ“‹ Jobs completed:"
          echo "  âš™ï¸ Run All Validation Checks"
          echo "  ğŸ§ª Install Script Test (Arch Linux)"
          echo ""
          echo "ğŸŠ Dotfiles repository validation successful!"
          echo "âœ… Ready for deployment!"
